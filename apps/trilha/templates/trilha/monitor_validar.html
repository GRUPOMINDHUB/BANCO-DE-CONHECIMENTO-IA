{% extends "trilha/base_monitor.html" %}

{% block content %}
<!-- Filtros -->
<div class="glass rounded-xl p-4 mb-6 flex items-center gap-4">
    <div class="flex items-center gap-2">
        <i class="fas fa-filter text-gray-400"></i>
        <span class="text-sm text-gray-400">Filtrar:</span>
    </div>
    <button onclick="filterBy('all')" class="filter-btn active px-4 py-2 rounded-lg text-sm transition-all" data-filter="all">
        Todos
    </button>
    <button onclick="filterBy('pendente')" class="filter-btn px-4 py-2 rounded-lg text-sm transition-all" data-filter="pendente">
        Pendentes
    </button>
    <button onclick="filterBy('aprovado')" class="filter-btn px-4 py-2 rounded-lg text-sm transition-all" data-filter="aprovado">
        Aprovados
    </button>
    <button onclick="filterBy('reprovado')" class="filter-btn px-4 py-2 rounded-lg text-sm transition-all" data-filter="reprovado">
        Reprovados
    </button>
</div>

<!-- Lista de Submissões -->
<div id="submissoes-list" class="space-y-4">
    <div class="text-center py-8 text-gray-400">
        <i class="fas fa-spinner fa-spin text-2xl"></i>
        <p class="mt-2">Carregando submissões...</p>
    </div>
</div>

<!-- Modal de Validação -->
<div id="modal-validar" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4">
    <div class="glass rounded-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="p-6" id="modal-content">
            <!-- Conteúdo dinâmico -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .filter-btn {
        background: transparent;
        color: #9ca3af;
    }
    .filter-btn:hover {
        background: rgba(63, 63, 63, 0.5);
        color: white;
    }
    .filter-btn.active {
        background: #e30613;
        color: white;
    }
    
    .submissao-card {
        transition: all 0.2s;
    }
    .submissao-card:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let submissoesData = [];
let currentFilter = 'all';
let currentSubmissao = null;

async function loadSubmissoes() {
    try {
        const response = await fetch('/api/monitor/submissoes-pendentes/');
        const data = await response.json();
        
        submissoesData = data.submissoes;
        renderSubmissoes();
        
    } catch (error) {
        console.error('Erro ao carregar submissões:', error);
        document.getElementById('submissoes-list').innerHTML = `
            <div class="text-center py-8 text-red-500">
                <i class="fas fa-exclamation-triangle text-2xl"></i>
                <p class="mt-2">Erro ao carregar submissões</p>
            </div>
        `;
    }
}

function filterBy(filter) {
    currentFilter = filter;
    
    // Update buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) {
            btn.classList.add('active');
        }
    });
    
    renderSubmissoes();
}

function renderSubmissoes() {
    const container = document.getElementById('submissoes-list');
    
    let filtered = submissoesData;
    
    // Por enquanto só temos pendentes na API, mas a estrutura está preparada
    // para quando adicionarmos histórico de validadas
    
    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="text-center py-12">
                <div class="w-16 h-16 mx-auto bg-green-500/20 rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-check text-green-500 text-2xl"></i>
                </div>
                <p class="text-lg font-medium">Tudo em dia!</p>
                <p class="text-gray-400 mt-1">Não há submissões pendentes de validação</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = filtered.map(s => `
        <div class="submissao-card glass rounded-xl p-6 cursor-pointer" onclick="openModal(${s.id})">
            <div class="flex items-start gap-4">
                <!-- Avatar -->
                <div class="w-12 h-12 rounded-full bg-mindhub-gray flex items-center justify-center overflow-hidden flex-shrink-0">
                    ${s.aluno.foto 
                        ? `<img src="${s.aluno.foto}" class="w-full h-full object-cover">` 
                        : `<i class="fas fa-user text-gray-400"></i>`}
                </div>
                
                <!-- Info -->
                <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between">
                        <div>
                            <h4 class="font-semibold">${s.aluno.nome}</h4>
                            <p class="text-sm text-gray-400">${s.aluno.email}</p>
                        </div>
                        <span class="bg-yellow-500/20 text-yellow-500 text-xs px-3 py-1 rounded-full">
                            Pendente
                        </span>
                    </div>
                    
                    <div class="mt-3 flex items-center gap-4 text-sm">
                        <div class="flex items-center gap-2 text-gray-400">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${s.step.mundo}</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-400">
                            <i class="fas fa-flag-checkered"></i>
                            <span>${s.step.titulo}</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-400">
                            <i class="fas fa-${getIconeTipo(s.step.tipo_validacao)}"></i>
                            <span>${s.step.tipo_validacao}</span>
                        </div>
                    </div>
                    
                    <p class="text-xs text-gray-500 mt-2">
                        Enviado em ${formatDate(s.data_envio)}
                    </p>
                </div>
                
                <!-- Action -->
                <div class="flex-shrink-0">
                    <i class="fas fa-chevron-right text-gray-400"></i>
                </div>
            </div>
        </div>
    `).join('');
}

function getIconeTipo(tipo) {
    const icones = {
        'FOTO': 'camera',
        'FORMULARIO': 'list-alt',
        'TEXTO': 'file-alt'
    };
    return icones[tipo] || 'file';
}

async function openModal(submissaoId) {
    currentSubmissao = submissoesData.find(s => s.id === submissaoId);
    if (!currentSubmissao) return;
    
    const s = currentSubmissao;
    
    document.getElementById('modal-content').innerHTML = `
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold">Validar Submissão</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Aluno Info -->
        <div class="flex items-center gap-4 mb-6 p-4 bg-mindhub-dark/50 rounded-lg">
            <div class="w-14 h-14 rounded-full bg-mindhub-gray flex items-center justify-center overflow-hidden">
                ${s.aluno.foto 
                    ? `<img src="${s.aluno.foto}" class="w-full h-full object-cover">` 
                    : `<i class="fas fa-user text-xl text-gray-400"></i>`}
            </div>
            <div>
                <h4 class="font-semibold">${s.aluno.nome}</h4>
                <p class="text-sm text-gray-400">${s.aluno.email}</p>
            </div>
        </div>
        
        <!-- Step Info -->
        <div class="mb-6">
            <p class="text-sm text-gray-400 mb-1">Step</p>
            <div class="flex items-center gap-2">
                <span class="text-mindhub-red">${s.step.mundo}</span>
                <i class="fas fa-chevron-right text-xs text-gray-500"></i>
                <span>${s.step.titulo}</span>
            </div>
        </div>
        
        <!-- Conteúdo da Submissão -->
        <div class="mb-6">
            <p class="text-sm text-gray-400 mb-2">Conteúdo Enviado</p>
            <div class="bg-mindhub-dark/50 rounded-lg p-4">
                ${s.arquivo ? `
                    <div class="mb-4">
                        <p class="text-sm text-gray-400 mb-2">Arquivo:</p>
                        ${isImage(s.arquivo) 
                            ? `<img src="${s.arquivo}" class="max-w-full rounded-lg" alt="Submissão">`
                            : `<a href="${s.arquivo}" target="_blank" class="text-mindhub-red hover:underline">
                                <i class="fas fa-file-download mr-2"></i>Baixar arquivo
                               </a>`
                        }
                    </div>
                ` : ''}
                
                ${s.resposta_texto ? `
                    <div class="mb-4">
                        <p class="text-sm text-gray-400 mb-2">Resposta em texto:</p>
                        <p class="whitespace-pre-wrap">${s.resposta_texto}</p>
                    </div>
                ` : ''}
                
                ${s.resposta_formulario ? `
                    <div>
                        <p class="text-sm text-gray-400 mb-2">Respostas do formulário:</p>
                        <pre class="text-sm bg-mindhub-darker/50 p-3 rounded overflow-auto">${JSON.stringify(s.resposta_formulario, null, 2)}</pre>
                    </div>
                ` : ''}
                
                ${!s.arquivo && !s.resposta_texto && !s.resposta_formulario ? `
                    <p class="text-gray-400 text-center py-4">Nenhum conteúdo enviado</p>
                ` : ''}
            </div>
        </div>
        
        <!-- Feedback -->
        <div class="mb-6">
            <label class="text-sm text-gray-400 block mb-2">Feedback (obrigatório para reprovação)</label>
            <textarea id="feedback-text" rows="3" 
                      class="w-full bg-mindhub-dark/50 border border-mindhub-gray/50 rounded-lg p-3 text-white 
                             focus:outline-none focus:border-mindhub-red resize-none"
                      placeholder="Digite seu feedback aqui..."></textarea>
        </div>
        
        <!-- Actions -->
        <div class="flex gap-4">
            <button onclick="validarSubmissao(false)" 
                    class="flex-1 py-3 bg-red-500/20 hover:bg-red-500/30 text-red-500 
                           rounded-lg font-medium transition-all">
                <i class="fas fa-times mr-2"></i>Reprovar
            </button>
            <button onclick="validarSubmissao(true)" 
                    class="flex-1 py-3 bg-green-500 hover:bg-green-600 text-white 
                           rounded-lg font-medium transition-all">
                <i class="fas fa-check mr-2"></i>Aprovar
            </button>
        </div>
    `;
    
    document.getElementById('modal-validar').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('modal-validar').classList.add('hidden');
    currentSubmissao = null;
}

function isImage(url) {
    return /\.(jpg|jpeg|png|gif|webp)$/i.test(url);
}

async function validarSubmissao(aprovado) {
    if (!currentSubmissao) return;
    
    const feedback = document.getElementById('feedback-text').value.trim();
    
    if (!aprovado && !feedback) {
        alert('Feedback é obrigatório para reprovação');
        return;
    }
    
    try {
        const response = await fetch(`/api/monitor/submissao/${currentSubmissao.id}/validar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ aprovado, feedback })
        });
        
        const data = await response.json();
        
        if (data.success) {
            closeModal();
            loadSubmissoes();
            atualizarBadgePendentes();
        } else {
            alert(data.error || 'Erro ao validar submissão');
        }
    } catch (error) {
        console.error('Erro ao validar:', error);
        alert('Erro ao validar submissão');
    }
}

function formatDate(isoString) {
    const date = new Date(isoString);
    return date.toLocaleDateString('pt-BR') + ' às ' + date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
}

function refreshData() {
    loadSubmissoes();
}

// Close modal on overlay click
document.getElementById('modal-validar').addEventListener('click', (e) => {
    if (e.target.id === 'modal-validar') {
        closeModal();
    }
});

// Close on ESC
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeModal();
    }
});

document.addEventListener('DOMContentLoaded', loadSubmissoes);
</script>
{% endblock %}
